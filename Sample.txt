From: john.doe@bankcorp.com
To: michael.smith@tradinghouse.com
Date: 2024-10-18
Subject: Regarding the Project Approval

Hi Michael,

As discussed earlier, if you can offer a small payoff or some form of kickback, 
I will push the approval through faster on our end.

This will remain secret between us. 
Please do not share this conversation with anyone else in the team.

Regards,
John

From: sarah.lee@bankcorp.com
To: external.trader@partnerfund.com
Date: 2024-10-20
Subject: Non-public update ahead of the announcement

Hi,

Please keep this confidential.
The pricing strategy for Q4 will be changed based on the insider data we reviewed yesterday. 
This information is non-public until next Monday.

Make sure your team adjusts positions before the announcement.

Regards,
Sarah

===========================================================================

def handle_reviewer_action(identifier: str, category: str, action_label: str):
    """
    Handle reviewer click. action_label is 'TP' or 'FP'.
    Updates per-category review state, updates sourcelines feedback, writes reviewer feedback,
    updates categorized json and session.
    """

    # Feedback text mapping
    feedback_map = {
        "TP": "True positive / Correct prediction",
        "FP": "False positive / Manual review required"
    }

    # Find the email record in session_state or disk
    target = None
    if 'processed_emails' in st.session_state:
        for e in st.session_state.processed_emails:
            if e.get('Identifier') == identifier:
                target = e
                break

    # Fallback: load from disk
    if target is None:
        p = CATEGORIZED_DIR / f"{identifier}.json"
        if p.exists():
            try:
                with open(p, 'r', encoding='utf-8') as f:
                    target = json.load(f)
            except Exception:
                target = None

    if target is None:
        st.error(f"Could not find email record for Identifier {identifier}")
        return

    # Ensure per-category review structure exists
    if 'category_reviews' not in target:
        target['category_reviews'] = {}

    # Normalize label
    action_label = action_label.upper()
    if action_label not in ('TP', 'FP'):
        st.error("Invalid reviewer action")
        return

    # Update per-category review
    target['category_reviews'][category] = action_label
    target['manualOverride'] = True

    # ---------------------------
    # UPDATE FEEDBACK IN SOURCELINES
    # ---------------------------
    for c in target.get("categories", []):
        if c.get("category") == category:
            for s in c.get("sourcelines", []):
                s["feedback"] = feedback_map[action_label]
            break

    # ---------------------------
    # PREPARE REVIEWER FEEDBACK OBJECT
    # ---------------------------
    fb = {
        "Identifier": identifier,
        "category": category,
        "action": action_label,
        "feedback": feedback_map[action_label],
        "timestamp": time.time(),
        "subject": target.get("subject", ""),
        "sourcelines": []
    }

    # Copy updated sourcelines
    for c in target.get("categories", []):
        if c.get("category") == category:
            lines_list = []
            for s in c.get("sourcelines", []):
                line_text = s.get("lines", "") if isinstance(s, dict) else str(s)
                lines_list.append({
                    "lines": line_text,
                    "feedback": feedback_map[action_label]
                })
            fb["sourcelines"] = lines_list
            break

    # Save reviewer feedback (deduplicates automatically)
    add_reviewer_feedback(fb)

    # Save audit log
    simulate_db_log_action(identifier, "REVIEWER_ACTION", {
        "category": category,
        "action": action_label
    })

    # ---------------------------
    # COMPUTE OVERALL EMAIL RESULT
    # ---------------------------
    cat_reviews = target.get("category_reviews", {})
    categories_list = [c.get("category") for c in target.get("categories", []) if c.get("category")]
    if not categories_list:
        categories_list = list(cat_reviews.keys())

    any_fp = any(cat_reviews.get(c) == 'FP' for c in categories_list if c in cat_reviews)
    all_tp = categories_list and all(cat_reviews.get(c) == 'TP' for c in categories_list)

    if any_fp:
        target['falsePositive'] = True
        target['reviewer_action'] = "FALSE_POSITIVE"
    elif all_tp:
        target['falsePositive'] = False
        target['reviewer_action'] = "TRUE_POSITIVE"
    else:
        target['falsePositive'] = False
        target['reviewer_action'] = "PENDING"

    target["manualOverride"] = True

    # ---------------------------
    # SAVE UPDATED CATEGORIZED FILE + SESSION UPDATE
    # ---------------------------
    try:
        _write_categorized_file_and_state(identifier, target)
    except Exception as e:
        simulate_db_log_action(identifier, "WRITE_UPDATE_ERR", {"error": str(e)})

    # ---------------------------
    # SAFE UI REFRESH (no rerun errors)
    # ---------------------------
    st.success(f"Marked {category} as {action_label}")
    st.session_state["_force_refresh"] = time.time()
